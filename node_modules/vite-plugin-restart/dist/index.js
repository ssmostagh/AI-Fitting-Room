import { createHash } from "node:crypto";
import { existsSync, readFileSync } from "node:fs";
import path from "node:path";
import process from "node:process";
import micromatch from "micromatch";

//#region src/index.ts
let i = 0;
const globalFileHashes = /* @__PURE__ */ new Map();
function toArray(arr) {
	if (!arr) return [];
	if (Array.isArray(arr)) return arr;
	return [arr];
}
function VitePluginRestart(options = {}) {
	const { delay = 500, glob: enableGlob = true, contentCheck = true } = options;
	let root = process.cwd();
	let reloadGlobs = [];
	let restartGlobs = [];
	let timerState = "reload";
	let timer;
	let fileHashes;
	function clear() {
		clearTimeout(timer);
	}
	function schedule(fn) {
		clear();
		timer = setTimeout(fn, delay);
	}
	function getFileHash(filePath) {
		try {
			if (!existsSync(filePath)) return null;
			const content = readFileSync(filePath);
			return createHash("sha256").update(content).digest("hex");
		} catch {
			return null;
		}
	}
	function hasContentChanged(filePath) {
		if (!contentCheck) return true;
		const currentHash = getFileHash(filePath);
		const previousHash = fileHashes.get(filePath);
		if (previousHash === void 0) {
			if (currentHash !== null) fileHashes.set(filePath, currentHash);
			return currentHash !== null;
		}
		const hasChanged = currentHash !== previousHash;
		if (currentHash !== null) fileHashes.set(filePath, currentHash);
		else fileHashes.delete(filePath);
		return hasChanged;
	}
	return {
		name: `vite-plugin-restart:${i++}`,
		apply: "serve",
		config(c) {
			if (!enableGlob) return;
			if (!c.server) c.server = {};
			if (!c.server.watch) c.server.watch = {};
			c.server.watch.disableGlobbing = false;
		},
		configResolved(config) {
			root = config.root;
			if (!globalFileHashes.has(root)) globalFileHashes.set(root, /* @__PURE__ */ new Map());
			fileHashes = globalFileHashes.get(root);
			restartGlobs = toArray(options.restart).map((i$1) => path.posix.join(root, i$1));
			reloadGlobs = toArray(options.reload).map((i$1) => path.posix.join(root, i$1));
		},
		configureServer(server) {
			server.watcher.add([...restartGlobs, ...reloadGlobs]);
			server.watcher.on("add", handleFileChange);
			server.watcher.on("change", handleFileChange);
			server.watcher.on("unlink", handleFileChange);
			function handleFileChange(file) {
				if (!hasContentChanged(file)) return;
				if (micromatch.isMatch(file, restartGlobs)) {
					timerState = "restart";
					schedule(() => {
						server.restart();
					});
				} else if (micromatch.isMatch(file, reloadGlobs) && timerState !== "restart") {
					timerState = "reload";
					schedule(() => {
						server.ws.send({ type: "full-reload" });
						timerState = "";
					});
				}
			}
		}
	};
}
var src_default = VitePluginRestart;

//#endregion
export { src_default as default };